\documentclass{article}
\usepackage{amsmath,amssymb,mathtools}
\usepackage[a4paper,margin=1in]{geometry}
\usepackage{xparse}
\usepackage{bm}

\title{PAI}
\author{Tiberiu Iancu}
\date{August 2025}

\begin{document}
\maketitle

% ---------- Notation ----------
\section*{Notation}
\newcommand{\ddfrac}[2]{\frac{\partial #1}{\partial #2}}
\RenewDocumentCommand{\v}{m g}{%
  \IfNoValueTF{#2}{\mathbf{#1}}{\mathbf{#1}_{#2}}%
}
\NewDocumentCommand{\ev}{m g}{%
  \IfNoValueTF{#2}{e^{\mathbf{#1}}}{e^{\mathbf{#1}_{#2}}}%
}
\newcommand{\colnorm}[1]{\left(\sum_{\text{col}} #1\right)}
\newcommand{\rownorm}[1]{\left(\sum_{\text{row}} #1\right)}
\newcommand{\lam}{\bm{\lambda}}

\NewDocumentCommand{\T}{m g}{%
  \IfNoValueTF{#2}{\v{T}^{(#1)}}{\v{T}{#2}^{(#1)}}%
}

\RenewDocumentCommand{\t}{m g}{%
  \IfNoValueTF{#2}{\v{t}^{(#1)}}{\v{t}{#2}^{(#1)}}%
}

Bold symbols denote vectors/matrices. Element-wise product is $\odot$. Broadcasting follows PyTorch: $\lam\in\mathbb{R}^B$ broadcasts across columns; $\ev{b},\ev{-b},\v{zn}\in\mathbb{R}^M$ broadcast across rows.

% ---------- Forward ----------
\section{Forward pass}

\newcommand{\C}{\mathcal{C}}

Given $\v{X}\in\mathbb{R}^{B\times K}$, $\v{Z}\in\mathbb{R}^{K\times M}$, $\v{r}\in\mathbb{R}^{M}$, $c\in\mathbb{R}$:
\begin{align}
\lam_b &:= \frac{2}{1 - c\sum_{k=1}^K \v{X}{bk}^2}\in\mathbb{R},\quad \v{\lam}\equiv(\lam_b)_{b=1}^B \\
\v{zn}{m} &:= \Big(\sum_{k=1}^K \v{Z}{km}^2\Big)^{1/2},\quad \v{zn}\in\mathbb{R}^M \\
\v{b} &:= 2\sqrt{c}\,\odot\,\v{r}\\
\v{P} &:= \tfrac12\Big[(\ev{b}+\ev{-b})\,\odot\,\Big( \tfrac{\sqrt{c}\,\v{\lam}}{\v{zn}} \,\odot\, \v{XZ}\Big)\ -\ (\ev{b}-\ev{-b})\,\odot\,(\lam-\mathbf{1})\Big] \in \mathbb{R}^{B\times M} \\
\v{D} &:= 2\odot \v{zn}\,\odot\, \log\!\big(\v{P}+\sqrt{\v{P}^2+\mathbf{1}}\big) \\
\v{num} &:= \tfrac{1}{2\sqrt{c}}\,(\ev{D}+\ev{-D}) \\
\v{den}{b} &:= 1 + \sqrt{\,1 + c \sum_{m=1}^M \v{num}{bm}^2\,},\quad \v{den}\equiv(\v{den}{b})_{b=1}^B \\
\v{Y} &:= \tfrac{\v{num}}{\v{den}} \\
\v{yn}_b &:= \Big(\sum_{m=1}^M \v{Y}{bm}^2\Big)^{1/2},\quad \v{yn}\equiv(\v{yn}_b)_{b=1}^B \\
\v{mn}_i &:= \min\!\Big(\v{yn}{i},\,\C\Big),\quad \C = \tfrac{1-\epsilon}{\sqrt{\,c+\exp(-15)\,}},\ \quad \v{mn}\equiv(\v{mn}_i)_{i=1}^B \\
\v{py} &:= \v{Y}\,\odot\,\frac{\v{mn}}{\v{yn}}.
\end{align}

% \paragraph{Implementation notes.}
% Clamp denominators (\texttt{zn}, \texttt{yn}, \texttt{den-1}, \texttt{p+\sqrt{p^2+1}}) with a small \texttt{eps}. All divisions are elementwise with PyTorch broadcasting.

% ---------- Backward w.r.t. x ----------
\section{Backward w.r.t. $\v{X}$}

Let $\v{dout}:=\ddfrac{\mathcal{L}}{\v{py}}\in\mathbb{R}^{B\times M}$. For arbitrary indices $b,k$:
\begin{align}
\ddfrac{\mathcal{L}}{\v{X}{bk}}
&= \sum_m \v{dout}{bm}\,\ddfrac{\v{py}{bm}}{\v{X}{bk}}
= \sum_m \underbrace{\left( \sum_j \v{dout}{bj} \ddfrac{\v{py}{bm}}{\v{y}{bj}} \right)}_{:=\,\T{1}{bm}} \,\ddfrac{\v{Y}{bm}}{\v{X}{bk}} \\
\T{1}{bm} &=
\begin{cases}
  \v{dout}{bm}, & \text{if } \v{yn}_b \le \mathcal{C}, \\[6pt]
  \frac{\mathcal{C}}{\v{yn}{b}}\,\left(\v{dout}{bm} - \v{yn}{b}^{-2}\,\v{Y}{bm}\,\sum_j \v{dout}{bj}\,\v{Y}{bj}\right),
    & \text{if } \v{yn}_b > \mathcal{C}.
\end{cases} \\
\end{align}
Since $\v{Y}{bm}=\v{num}{bm}/\v{den}{b}$ and $\v{den}{b} = 1+\sqrt{1+c\sum_i \v{num}{bi}^2}$,
\begin{align}
\ddfrac{\v{Y}{bm}}{\v{X}{bk}}
&= \frac{1}{\v{den}{b}}\ddfrac{\v{num}{bm}}{\v{X}{bk}} - \frac{\v{num}{bm}}{\v{den}{b}^2}\frac{c}{\v{den}{b}-1}\sum_i \v{num}{bi}\ddfrac{\v{num}{bi}}{\v{X}{bk}} \\
\Rightarrow \ddfrac{\mathcal{L}}{\v{X}{bk}} &= \left( \sum_m \T{1}{bm}\,\frac{1}{\v{den}{b}}\ddfrac{\v{num}{bm}}{\v{X}{bk}} \right) - \left( \frac{c\,\sum_m \T{1}{bm} \v{num}{bm}}{\v{den}{b}^2\,(\v{den}{b}-1)}\sum_i \v{num}{bi}\ddfrac{\v{num}{bi}}{\v{X}{bk}} \right) \\
&= \left( \sum_m \frac{\T{1}{bm}}{\v{den}{b}}\ddfrac{\v{num}{bm}}{\v{X}{bk}} - \frac{c\,\sum_i \T{1}{bi} \v{num}{bi}}{\v{den}{b}^2\,(\v{den}{b}-1)} \v{num}{bm}\ddfrac{\v{num}{bm}}{\v{X}{bk}} \right) \\
&= \sum_m \left( \frac{\T{1}{bm}}{\v{den}{b}} - \frac{c\,\sum_i \T{1}{bi}\, \v{num}{bi}}{\v{den}{b}^2\,(\v{den}{b}-1)} \v{num}{bm} \right) \ddfrac{\v{num}{bm}}{\v{X}{bk}}  \\
&= \sum_m \underbrace{\frac{1}{\v{den}{b}} \left(\T{1}{bm} - \frac{c\,\v{num}{bm}}{\v{den}{b}\,(\v{den}{b}-1)} \sum_i \T{1}{bi}\, \v{num}{bi}  \right)}_{:=\T{2}{bm}} \ddfrac{\v{num}{bm}}{\v{X}{bk}}  \\
\end{align}
Now $\v{num}=\tfrac{1}{2\sqrt{c}}(\ev{D}+\ev{-D})$ implies
\begin{align}
\ddfrac{\v{num}{bm}}{\v{X}{bk}}
= \frac{\ev{D}{bm}-\ev{-D}{bm}}{2\sqrt{c}}\ \ddfrac{\v{D}{bm}}{\v{X}{bk}}.
\end{align}
With $\v{D}{bm}=2\,\v{zn}{m}\,\log\!\big(\v{P}{bm}+\sqrt{\v{P}{bm}^2+1}\big)$:
\begin{align}
\ddfrac{\v{D}{bm}}{\v{X}{bk}}
= \frac{2\,\v{zn}{m}}{\sqrt{\v{P}{bm}^2+1}}\,\ddfrac{\v{P}{bm}}{\v{X}{bk}}.
\end{align}
Let
\[
\T{3}{bm}:= \T{2}{bm}\,\frac{\ev{D}{bm}-\ev{-D}{bm}}{2\sqrt{c}}\,\frac{\v{zn}{m}}{\sqrt{\v{P}{bm}^2+1}}
\]
then
\begin{align}
\ddfrac{\mathcal{L}}{\v{X}{bk}}
= \sum_m 2\,\T{3}{bm}\,\ddfrac{\v{P}{bm}}{\v{X}{bk}}.
\end{align}
From the definition of $\v{P}$:
\begin{align}
\ddfrac{\v{P}{bm}}{\v{X}{bk}}
&= \tfrac12(\ev{b}{m}+\ev{-b}{m})\,\frac{\sqrt{c}}{\v{zn}{m}}
\Big(\ddfrac{\lam_b}{\v{X}{bk}}\,\v{XZ}{bm} + \lam_b\,\ddfrac{\v{XZ}{bm}}{\v{X}{bk}}\Big)
- \tfrac12(\ev{b}{m}-\ev{-b}{m})\,\ddfrac{\lam_b}{\v{X}{bk}},
\\
\ddfrac{\lam_b}{\v{X}{bk}} &= c\,\lam_b^2\,\v{X}{bk},\qquad
\ddfrac{\v{XZ}{bm}}{\v{X}{bk}} = \v{Z}{km}.
\end{align}
Collecting terms:
\begin{align}
\ddfrac{\mathcal{L}}{\v{X}{bk}}
&= \v{X}{bk}\,\sum_m \underbrace{c\,\lam_b^2\,\T{3}{bm}\Big(\sqrt{c}\,\v{XZ}{bm}\,\frac{\ev{b}{m}+\ev{-b}{m}}{\v{zn}{m}} - (\ev{b}{m}-\ev{-b}{m})\Big)}_{:=\,\T{4}{bm}} \\
&\quad + \sum_m \underbrace{\sqrt{c}\,\lam_b \T{3}{bm}\,\frac{\ev{b}{m}+\ev{-b}{m}}{\v{zn}{m}}}_{:=\,\T{5}{bm}}\,\v{Z}{mk}^{\top}.
\end{align}
Vectorized:
\[
\boxed{\ \ddfrac{\mathcal{L}}{\v{X}} = \v{X} \odot \rownorm{\T{4}}\ +\ \T{5}\,\v{Z}^{\top}\ }\ \in\mathbb{R}^{B\times K}.
\]

% ---------- Backward w.r.t. z ----------
\section{Backward w.r.t. $\v{Z}$}

\begin{align}
\ddfrac{\mathcal{L}}{\v{Z}{km}}
&= \sum_b \v{dout}{bm}\,\ddfrac{\v{py}{bm}}{\v{Z}{km}}
= \sum_b \underbrace{\v{dout}{bm}\,\ddfrac{\v{py}{bm}}{\v{Y}{bm}}}_{=\,\T{1}{bm}}\ddfrac{\v{Y}{bm}}{\v{Z}{km}}.
\end{align}
As before,
\begin{align}
\ddfrac{\v{Y}{bm}}{\v{Z}{km}}
&= \frac{1}{\v{den}{b}}\Big(1-\frac{c\,\v{num}{bm}^2}{\v{den}{b}(\v{den}{b}-1)}\Big)
\ddfrac{\v{num}{bm}}{\v{Z}{km}},\\
\ddfrac{\v{num}{bm}}{\v{Z}{km}}
&= \frac{\ev{D}{bm}-\ev{-D}{bm}}{2\sqrt{c}}\ \ddfrac{\v{D}{bm}}{\v{Z}{km}}.
\end{align}
Define
\[
\T{6}{bm}:= \T{1}{bm}\,\frac{1}{\v{den}{b}}\Big(1-\frac{c\,\v{num}{bm}^2}{\v{den}{b}(\v{den}{b}-1)}\Big)\,\frac{\ev{D}{bm}-\ev{-D}{bm}}{2\sqrt{c}}.
\]
With $\v{D}{bm}=2\,\v{zn}{m}\,\log\!\big(\v{P}{bm}+\sqrt{\v{P}{bm}^2+1}\big)$:
\begin{align}
\ddfrac{\v{D}{bm}}{\v{Z}{km}}
&= 2\,\log\!\big(\v{P}{bm}+\sqrt{\v{P}{bm}^2+1}\big)\,\ddfrac{\v{zn}{m}}{\v{Z}{km}}
+ \frac{2\,\v{zn}{m}}{\sqrt{\v{P}{bm}^2+1}}\,\ddfrac{\v{P}{bm}}{\v{Z}{km}},
\\
\ddfrac{\v{zn}{m}}{\v{Z}{km}} &= \frac{\v{Z}{km}}{\v{zn}{m}},\qquad
\ddfrac{\v{P}{bm}}{\v{Z}{km}}
= \tfrac12(\ev{b}{m}+\ev{-b}{m})\,\sqrt{c}\,\lam_b\,
\Big(\v{X}{bk}\,\v{zn}{m}^{-1} - \v{XZ}{bm}\,\v{Z}{km}\,\v{zn}{m}^{-3}\Big).
\end{align}
Collecting and cancelling the factor $2$ with $1/(2\sqrt{c})$ inside $\T{6}{bm}$, define
\begin{align}
\T{7}{bm} &:= \frac{\T{6}{bm}}{\v{zn}{m}}\,\log\!\big(\v{P}{bm}+\sqrt{\v{P}{bm}^2+1}\big),\\
\T{8}{bm} &:= \T{6}{bm}\,\frac{\v{zn}{m}}{\sqrt{\v{P}{bm}^2+1}}
\cdot (\ev{b}{m}+\ev{-b}{m})\,\sqrt{c}\,\lam_b\,\tfrac{1}{2}\cdot \v{zn}{m},\\
\T{9}{bm} &:= \T{6}{bm}\,\frac{1}{\sqrt{\v{P}{bm}^2+1}}
\cdot (\ev{b}{m}+\ev{-b}{m})\,\sqrt{c}\,\lam_b\,\tfrac{1}{2}\cdot \v{XZ}{bm}.
\end{align}
Then
\[
\ddfrac{\mathcal{L}}{\v{Z}{km}}
= \sum_b \Big[(\T{7}{bm}+\T{9}{bm})\,\v{Z}{km} + \T{8}{bm}\,\v{X}{bk}\Big],
\quad
\boxed{\ \ddfrac{\mathcal{L}}{\v{Z}} = \v{Z}\,\odot\,\colnorm{\T{7}+\T{9}}\ +\ \v{X}^\top \T{8}\ }\in\mathbb{R}^{K\times M}.
\]

% ---------- Backward w.r.t. r ----------
\section{Backward w.r.t. $\v{r}$}

Start from the same chain with $\T{6}$:
\[
\ddfrac{\mathcal{L}}{\v{r}{m}}
= \sum_b \T{6}{bm}\,\ddfrac{\v{D}{bm}}{\v{r}{m}},
\]
and
\begin{align}
\ddfrac{\v{D}{bm}}{\v{r}{m}}
&= \frac{2\,\v{zn}{m}}{\sqrt{\v{P}{bm}^2+1}}\ \ddfrac{\v{P}{bm}}{\v{r}{m}},\qquad
\ddfrac{\v{P}{bm}}{\v{r}{m}}
= \sqrt{c}\Big[\tfrac12(\ev{b}{m}-\ev{-b}{m})\,\frac{c\,\lam_b}{\v{zn}{m}}
+ \tfrac12(\ev{b}{m}+\ev{-b}{m})\,(\lam_b-1)\Big],
\end{align}
since $\v{b}=2\sqrt{c}\,\v{r}$. Define
\[
\T{10}{bm}:=\frac{\T{6}{bm}\,\v{zn}{m}}{\sqrt{\v{P}{bm}^2+1}},
\]
then
\[
\ddfrac{\mathcal{L}}{\v{r}{m}}
= 2\sqrt{c}\left(
\left[\frac{c}{\v{zn}{m}}(\ev{b}{m}-\ev{-b}{m}) + (\ev{b}{m}+\ev{-b}{m})\right]\sum_b \T{10}{bm}\lam_b
- (\ev{b}{m}+\ev{-b}{m})\sum_b \T{10}{bm}
\right)
\]
\[
\boxed{\ \ddfrac{\mathcal{L}}{\v{r}} =
2\sqrt{c}\left(
\Big[c\,\tfrac{\ev{b}-\ev{-b}}{\v{zn}}+\ev{b}+\ev{-b}\Big]\odot \colnorm{\T{10}\odot\v{\lam}}
\ -\ (\ev{b}+\ev{-b})\odot \colnorm{\T{10}}
\right)\ }\in\mathbb{R}^{M}.
\]

\end{document}
