\documentclass{article}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{cancel}
\usepackage{xparse}
\usepackage[a4paper,margin=1in]{geometry}

\title{PAI}

\begin{document}

\maketitle

\section{Derivatives}

\subsection{Forward pass}

\newcommand{\ddfrac}[2]{\frac{\partial #1}{\partial #2}}
\RenewDocumentCommand{\v}{m g}{%
  \IfNoValueTF{#2}
    {\mathbf{#1}}%
    {\mathbf{#1}_{#2}}%
}
\newcommand{\colnorm}[1]{\|#1\|_{1,\text{col}}}
\newcommand{\rownorm}[1]{\|#1\|_{1,\text{row}}}

Let $\v{x} \in \mathbb{R}^{B\times K}$ be the layer input, $\v{z} \in \mathbb{R}^{K\times M}$ be the layer weights, $\v{r} \in \mathbb{R}^{M}$ be the layer biases, $c \in \mathbb{R}$ be the curvature.

\begin{align*}
    \lambda_b &:= \frac{2}{1 - c \cdot \sum_{k}^K\v{x}{bk}^2} \in \mathbb{R}^{B} \\
    \v{zn} &:= ||z||_0 \in \mathbb{R}^{M} \\
    \v{p} &:= \frac{\sqrt{c} \odot \lambda \odot \v{x} \v{z}}{\v{zn}} \in \mathbb{R}^{B\times M} \\
    \v{b} &:= 2 \odot \sqrt{c} \odot \v{r}; \quad \v{eb} := \exp(\v{b}); \quad \v{ebi} := \v{eb}^{-1} \in \mathbb{R}^{M} \\
    \v{p} &:= 0.5 \odot \left((\v{eb} + \v{ebi}) \odot \frac{\sqrt{c} \odot \lambda}{\v{zn}} \odot \v{x} \v{z} - (\v{eb} - \v{ebi}) * (\lambda - 1)\right) \\
    \v{d} &:= 2 \odot \v{zn} \odot \log(\v{p} + \sqrt{\v{p}^2 + 1}); \quad \v{ed} := \exp(\v{d}); \quad \v{edi} := \v{ed}^{-1}\\
    \v{num} &:= \frac{\v{ed} + \v{edi}}{2 * \sqrt{c}} \\
    \v{den} &:= 1 + \sqrt{1 + c * \sum_{m}^M \v{num}{m}^2} \\
    \v{y} &:= \frac{\v{num}}{\v{den}} \\
    \v{yn} &:= \sqrt{\sum_b^B \v{y}{b}} \\
    \v{py} &:= \v{y} \odot \frac{\v{mn}}{\v{yn}}, \text{where } \v{mn}{i} = \min(\v{yn}{i}, \frac{1 - \epsilon}{\sqrt{c + \exp(-15)}}) \\
\end{align*}

\section{Backward pass w.r.t. $\v{x}$}

\begin{align*}
    \ddfrac{\mathcal{L}}{\v{x}{bk}} &= \sum_m^M \v{dout}{bm} \ddfrac{\v{py}{bm}}{\v{x}{bk}} = \sum_m \v{dout}{bm} \ddfrac{\v{y}{bm} / \v{yn}{b} * \v{mn}{b}}{\v{x}{bk}} \\
    &= \v{mn}{b} \sum_m \v{dout}{bm} \left(\v{yn}{b}^{-1} \ddfrac{\v{y}{bm}}{\v{x}{bk}} - \v{y}{bm} \cdot \v{yn}{b}^{-2} \cdot \ddfrac{\v{yn}{b}}{\v{x}{bk}} \right) \\
    &= \v{mn}{b} \sum_m \v{dout}{bm} \left(\v{yn}{b}^{-1} \ddfrac{\v{y}{bm}}{\v{x}{bk}} - \v{y}{bm} \cdot \v{yn}{b}^{-2} \cdot \ddfrac{\sqrt{\sum_i^M \v{y}_{bi}^2}}{\v{x}{bk}} \right) \\
    &= \v{mn}{b} \sum_m \v{dout}{bm} \left(\v{yn}{b}^{-1} \ddfrac{\v{y}{bm}}{\v{x}{bk}} - \v{y}{bm} \cdot \v{yn}{b}^{-3} \cdot \frac{1}{2} \ddfrac{\sum_i^M \v{y}_{bi}^2}{\v{x}{bk}} \right) \\
    &= \v{mn}{b} \sum_m \v{dout}{bm} \left(\v{yn}{b}^{-1} \ddfrac{\v{y}{bm}}{\v{x}{bk}} - \v{y}{bm} \cdot \v{yn}{b}^{-3} \cdot \underbrace{\sum_i^M \v{y}_{bi} \ddfrac{ \v{y}_{bi}}{\v{x}{bk}}}_{\text{does not depend on $m$}} \right) \\
    &= \v{mn}{b} \v{yn}{b}^{-1} \left( \sum_m \v{dout}{bm} \ddfrac{\v{y}{bm}}{\v{x}{bk}} \right) - \left(\v{yn}{b}^{-3} \sum_m \v{y}{bm} \cdot \v{dout}{bm} \right) \sum_m \v{y}{bm} \ddfrac{\v{y}{bm}}{\v{x}{bk}} \\
    &= \sum_m \underbrace{\left[ \v{mn}{b} \v{yn}{b}^{-1} \v{dout}{bm} - \left(\v{yn}{b}^{-3} \sum_i^M \v{y}{bm} \cdot \v{dout}{bm} \right) \right]}_{:= \v{A}{bm}} \ddfrac{\v{y}{bm}}{\v{x}{bk}} \\
    &= \sum_m \v{A}{bm} \left( \frac{1}{\v{den}{b}} \ddfrac{\v{num}{bm}}{\v{x}{bk}} - \frac{\v{num}{bm}}{\v{den}{b}^{2}} \ddfrac{\v{den}{b}}{\v{x}{bk}} \right) \\
    &= \sum_m \v{A}{bm} \left( \frac{1}{\v{den}{b}} \ddfrac{\v{num}{bm}}{\v{x}{bk}} - \frac{\v{num}{bm}}{\v{den}{b}^{2}} \ddfrac{1 + \sqrt{1 + c \cdot \sum_i^M \v{num}{bm}^2}}{\v{x}{bk}} \right) \\
    &= \sum_m \v{A}{bm} \left( \frac{1}{\v{den}{b}} \ddfrac{\v{num}{bm}}{\v{x}{bk}} - \frac{\v{num}{bm}}{\v{den}{b}^{2}} \frac{c}{\v{den}{b} - 1} \sum_i^M \v{num}{bi} \ddfrac{\v{num}{bi}}{\v{x}{bk}} \right) \\
    &= \left( \sum_m \v{A}{bm} \frac{1}{\v{den}{b}} \ddfrac{\v{num}{bm}}{\v{x}{bk}} \right) - \underbrace{\left(\sum_m \frac{\v{num}{bm}}{\v{den}{b}^{2}} \frac{c}{\v{den}{b} - 1} \right)}_{= \frac{c}{\v{den}{b} \cdot (\v{den}{b} - 1)} \sum_m \v{y}{bm} =: \v{b}{b}} \left( \sum_m \v{num}{bm} \ddfrac{\v{num}{bm}}{\v{x}{bk}} \right) \\
    &= \sum_m \underbrace{\left( \v{A}{bm} \frac{1}{\v{den}{b}} - \v{num}{bm} \v{b}{b} \right)}_{:= \v{C}{bm}} \ddfrac{\v{num}{bm}}{\v{x}{bk}} \\
    &= \sum_m \underbrace{\v{C}{bm} (\v{ed}_{bm} - \v{edi}_{bm})}_{:= \v{D}{bm}} \ddfrac{\v{d}{bm}}{\v{x}{bk}}
\end{align*}

\begin{align*}
    \ddfrac{\mathcal{L}}{\v{x}{bk}} = &\sum_m 2 \cdot \underbrace{\v{D}{bm} \cdot \v{zn}{m} \cdot \frac{1 + \sqrt{\v{p}{bm}^2 + 1}}{\v{p}{bm} + \sqrt{\v{p}{bm}^2 + 1}}}_{:= \v{E}{bm}} \ddfrac{\v{p}{bm}}{\v{x}{bk}} \\
    = &\sum_m \cancel{2} \v{E}{bm} \left( \cancel{\frac{1}{2}} (\v{eb}{m} + \v{ebi}{m}) \frac{\sqrt{c}}{\v{zn}{m}} \left( \ddfrac{\lambda_b}{\v{x}{bk}} \cdot \v{x} \v{z}{bm} + \ddfrac{\v{x} \v{z}{bm}}{\v{x}{bk}} \cdot \lambda_b \right) - \cancel{\frac{1}{2}} (\v{eb}{m} - \v{ebi}{m}) \ddfrac{\lambda_b}{\v{x}{bk}} \right) \\
    \ddfrac{\lambda_b}{\v{x}{bk}} = & \ddfrac{\frac{2}{1 - c \sum_j^K \v{x}{bj}^2}}{\v{x}{bk}} = -\frac{\lambda_b^2}{2} \cdot \ddfrac{-c \cdot \sum_i^M \v{x}{bj}^2}{\v{x}{bk}} = \lambda_b^2 \v{x}{bk} \\
    \ddfrac{\v{x} \v{z}{bm}}{\v{x}{bk}} =& \ddfrac{\sum_j^K \v{x}{bj} \cdot \v{z}{jm}}{\v{x}{bk}} = \v{z}{km} \\
    \Rightarrow \ddfrac{\mathcal{L}}{\v{x}{bk}} = &\sum_m \v{E}{bm} \cdot (\v{eb}{m} + \v{ebi}{m}) \cdot \frac{\sqrt{c}}{\v{zn}{m}} \cdot \lambda_b^2 \cdot\v{x}{bk} \cdot \v{x} \v{z}{bm} \\
    &+ \sum_m \v{E}{bm} \cdot (\v{eb}{m} + \v{ebi}{m}) \cdot \frac{\sqrt{c}}{\v{zn}{m}} \cdot \lambda_b \cdot \v{z}{km} \\
    &- \sum_m \v{E}{bm} \cdot (\v{eb}{m} - \v{ebi}{m}) \cdot \lambda_b^2 \cdot \v{x}{bk} \\
    =& \lambda_b^2 \cdot \v{x}{bk} \cdot \sum_m \underbrace{\v{E}{bm} \cdot \left( \sqrt{c} \cdot \v{x} \v{z}{bm} \cdot (\v{eb}{m} + \v{ebi}{m}) \cdot \v{zn}{m}^{-1} - (\v{eb}{m} - \v{ebi}{m}) \right)}_{:= \v{F}{bm}}\\
    &+ \sqrt{c} \cdot \lambda_b \cdot \sum_m \underbrace{\v{E}{bm} \cdot (\v{eb}{m} + \v{ebi}{m}) \cdot \v{zn}{m}^{-1}}_{:= \v{G}{bm}} \cdot \v{z}{km} \\
    \Rightarrow \ddfrac{\mathcal{L}}{\v{x}} =& \lambda^2 \odot \v{x} \odot \rownorm{\v{F}} + \sqrt{c} \odot \lambda \odot \v{G} \v{z},\quad
\end{align*}

where $\rownorm{\v{F}}$ represents the vector containing the L1 norm of each row in $\v{F}$.

\begin{align*}
    \ddfrac{\mathcal{L}}{\v{z}{km}} = & \sum_b^B \v{dout}{bm} \ddfrac{\v{py}{bm}}{\v{z}{km}} = \sum_b^B \v{dout}{bm} \ddfrac{\v{y}{bm} / \v{yn}{b} \cdot \v{mn}{b}}{\v{z}{km}} \\
    =& \sum_b \v{mn}{b} \cdot \v{dout}{bm} \cdot \left(\v{yn}{b}^{-1} \cdot \ddfrac{\v{y}{bm}}{\v{z}{km}} - \v{y}{bm} \cdot \v{yn}{b}^{-3} \cdot \frac{1}{2} \cdot \underbrace{\ddfrac{\sum_i^M \v{y}_{bi}^2}{\v{z}{km}}}_{=2 \cdot \v{y}{bm} \cdot \ddfrac{\v{y}_bm}{\v{z}{km}}} \right) \\
    =& \sum_b \underbrace{\v{mn}{b} \cdot \v{dout}{bm} \cdot \v{yn}{b}^{-1} \left( 1 - \left( \frac{\v{y}{bm}}{\v{yn}{b}} \right)^2 \right)}_{:= \v{H}{bm}} \cdot \ddfrac{\v{y}{bm}}{\v{z}{km}} \\
    =& \sum_b \v{H}{bm} \ddfrac{\v{num}{bm} / \v{den}{b}}{\v{z}{km}} = \sum_b \v{H}{bm} \left( \frac{1}{\v{den}{b}} \ddfrac{\v{num}{bm}}{\v{z}{km}} - \frac{\v{num}{bm}}{\v{den}{b}^2} \frac{c}{\v{den}{b} - 1} \sum_i^M \v{num}{bi} \underbrace{\ddfrac{\v{num}{bi}}{\v{z}{km}}}_{=0 \text{ when } i\neq m}  \right) \\
    =& \sum_b \underbrace{\v{H}{bm} \frac{1}{\v{den}{b}} \left( 1 - \frac{c \cdot \v{num}{bm}^2}{\v{den}{b} (\v{den}{b} - 1)} \right)}_{:= \v{J}{bm}} \ddfrac{\v{num}{bm}}{\v{z}{km}} \\
    =& \sum_b \underbrace{\v{J}{bm} \frac{\v{ed}{bm} + \v{edi}{bm}}{\sqrt{c}}}_{\v{L}{bm}} \cdot \ddfrac{\v{d}{bm}}{\v{z}{km}} \\
    =& \sum_b \underbrace{\v{J}{bm} \frac{\v{ed}{bm} + \v{edi}{bm}}{\sqrt{c}}}_{\v{L}{bm}} \cdot \left( \log \left( \v{p}{bm} + \sqrt{\v{p}{bm}^2 + 1} \right) \ddfrac{\v{zn}{m}}{\v{z}{km}} + \frac{\v{zn}{m}}{\sqrt{\v{p}{bm}^2 + 1}} \ddfrac{\v{p}{bm}}{\v{z}{km}} \right) \\
    \ddfrac{\v{zn}{m}}{\v{z}{km}} =& \ddfrac{\sqrt{\sum_j^K \v{z}{jm}^2}}{\v{z}{km}} = \frac{1}{2 \cdot \v{zn}{m}} \ddfrac{\sum_j^K \v{z}{jm}^2}{\v{z}{km}} = \frac{1}{2 \cdot \v{zn}{m}} \cdot 2 \cdot \sum_j^K \v{z}{jm} \ddfrac{\v{z}{km}}{\v{z}{km}} = \frac{\v{z}{km}}{\v{zn}{m}} \\
    \ddfrac{\v{p}{km}}{\v{z}{km}} =& \frac{1}{2} \ddfrac{}{\v{z}{km}} \left[ \frac{(\v{eb}{m} + \v{ebi}{m}) \cdot \sqrt{c} \cdot \lambda_b \cdot \v{(xz)}{bm}}{\v{zn}{m}} - \underbrace{(\v{eb}{m} - \v{ebi}{m})(\lambda_b - 1)}_{\text{does not depend on } \v{z}{km}} \right] \\
    =& \frac{(\v{eb}{m} + \v{ebi}{m}) \cdot \sqrt{c} \cdot \lambda_b}{2} \ddfrac{\frac{\v{(xz)}{bm}}{\v{zn}{m}}}{\v{z}{km}}\\
    =& \frac{(\v{eb}{m} + \v{ebi}{m}) \cdot \sqrt{c} \cdot \lambda_b}{2} \left( \v{zn}{m} \underbrace{\ddfrac{\v{(xz)}{bm}}{\v{z}{km}}}_{=\v{x}{bk}} - \v{zn}{m}^{-2} \cdot \v{(xz)}{bm} \underbrace{\ddfrac{\v{zn}{m}}{\v{z}{km}}}_{=\frac{\v{z}{km}}{\v{zn}{m}}} \right) \\
    =& \frac{(\v{eb}{m} + \v{ebi}{m}) \cdot \sqrt{c} \cdot \lambda_b}{2} \left( \v{zn}{m} \cdot \v{x}{bk} - \v{zn}{m}^{-1} \cdot \v{(xz)}{bm} \cdot \v{z}{km} \right) \\
\end{align*}

\begin{align*}
    \Rightarrow \ddfrac{\mathcal{L}}{\v{z}{km}} =& \sum_b \underbrace{\frac{\v{L}{bm} \cdot \log \left(\v{p}{bm} + \sqrt{\v{p}{bm}^2 + 1} \right)}{\v{zn}{m}} }_{:= \v{N}{bm}} \cdot \v{z}{km} \\
    &+ \sum_b \underbrace{\v{L}{bm} \cdot \frac{\v{zn}{m}}{\sqrt{\v{p}{bm}^2 + 1}} \frac{(\v{eb}{m} + \v{ebi}{m}) \cdot \sqrt{c} \cdot \lambda_b}{2} \cdot \v{zn}{m}}_{:= \v{P}{bm}} \cdot \v{x}{bk} \\
    &+ \sum_b \underbrace{\v{L}{bm} \cdot \frac{\cancel{\v{zn}{m}}}{\sqrt{\v{p}{bm}^2 + 1}} \frac{(\v{eb}{m} + \v{ebi}{m}) \cdot \sqrt{c} \cdot \lambda_b}{2} \cdot \cancel{\v{zn}{m}^{-1}} \cdot \v{(xz)}{bm}}_{:= \v{Q}{bm}} \cdot \v{z}{km} \\
    =& \left[ \v{z}{mk} \cdot \sum_b (\v{N} + \v{Q})_{bm} \right] + \sum_b \v{(x^T)}{kb} \cdot \v{P}{bm} \\
    \Rightarrow \ddfrac{\mathcal{L}}{\v{z}} =& \v{z} \odot \colnorm{\v{N} + \v{Q}} + \v{x^T} \v{P}
\end{align*}

\begin{align*}
    \ddfrac{\mathcal{L}}{\v{r}_m} =& \sum_b \v{L}{bm} \ddfrac{\v{d}{bm}}{\v{r}{m}} \\
    =& \sum_b \underbrace{\frac{\v{L}{bm} \cdot \v{zn}{m}}{\sqrt{\v{p}{bm}^2 + 1}}}_{:= \v{R}{bm}} \cdot 2 \ddfrac{\v{p}{bm}}{\v{r}{m}} \\
    =& \sum_b \v{R}{bm} \left[ \ddfrac{(\v{eb}{m} + \v{ebi}{m})}{\v{r}{m}} \cdot \frac{c \cdot \lambda_b}{\v{zn}{m}} + \ddfrac{(\v{eb}{m} + \v{ebi}{m})}{\v{r}{m}} (\lambda_b - 1) \right] \\
    =& \sum_b \v{R}{bm} \left[ 2\sqrt{c} \cdot \frac{c \cdot \lambda_b}{\v{zn}{m}} \cdot (\v{eb}{m} - \v{ebi}{m}) + 2\sqrt{c} (\lambda_b - 1) \cdot (\v{eb}{m} + \v{ebi}{m}) \right] \\
    =& 2\sqrt{c}\left(\left[\frac{c}{\v{zn}{m}}(\v{eb}{m}-\v{ebi}{m})+(\v{eb}{m}+\v{ebi}{m})\right]\sum_b \v{R}{bm}\lambda_b -(\v{eb}{m}+\v{ebi}{m})\sum_b \v{R}{bm}\right) \\
    \Rightarrow \ddfrac{\mathcal{L}}{\v{r}} =& 2 \sqrt{c} \cdot \left( \left[ c\cdot \frac{\v{eb} - \v{ebi}}{\v{zn}} + \v{eb} + \v{ebi} \right] \colnorm{\v{R} \odot \lambda} + \colnorm{R} \right)
\end{align*}

\end{document}
